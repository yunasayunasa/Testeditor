
<!-- manual.html -->

<h1>アクションタグ・リファレンス</h1>
<p>イベントに応じて、オブジェクトに様々なアクションを実行させるための命令です。</p>

<hr>

<h2>[time_stop]</h2>
<p>ゲーム全体の時間を停止させます。物理演算、Tween、タイマーなど、時間経過に依存する全てのものが停止します。アクションステージの冒頭などに用います。</p>
<p><strong>注意:</strong> このタグは、<code>onReady</code>トリガーと併用するのが最も安全で効果的です。これにより、シーンの全てのオブジェクトが生成された直後に時間が停止し、予期せぬ挙動を防ぎます。</p>
<p><strong>パラメータ:</strong> なし</p>
<p><strong>使用例:</strong></p>
<pre><code>
--- イベント (オブジェクト "OpeningEvent" に設定) ---
Trigger: onReady
Actions: [time_stop]
</code></pre>

<hr>

<h2>[time_resume]</h2>
<p><code>[time_stop]</code>によって停止されたゲーム全体の時間を再開させます。通常、UIボタン（例：「イベント開始」ボタン）が押された際の<code>onClick</code>イベントと連携して使用されます。</p>
<p><strong>パラメータ:</strong> なし</p>
<p><strong>使用例:</strong></p>
<pre><code>
--- イベント (オブジェクト "StartButton" に設定) ---
Trigger: onClick
Actions: [time_resume][destroy target=self]
</code></pre>

<hr>

<h2>[transition_scene]</h2>
<p>
    現在のゲームシーンを終了し、指定された新しいゲームシーンを開始します。
    ステージ間の移動、ワールドマップからダンジョンへの進入など、ゲームエリアの遷移全般を管理する、極めて重要なタグです。
</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>scene</strong> (必須): 遷移先のシーンのキー（例: <code>JumpScene</code>, <code>WorldMapScene</code>）。</li>
    <li><strong>data</strong> (任意): 遷移先のシーンが読み込むべき、レイアウトJSONデータのキーを指定します。これにより、同じ<code>JumpScene</code>を使いながら、異なるステージ（例: <code>cave_stage</code>, <code>castle_stage</code>）を読み込ませることができます。</li>
    <li><strong>script</strong> (任意): 遷移先がノベルシーンの場合に、開始するシナリオファイル名を指定します。</li>
    <li><strong>fade_time</strong> (任意): 画面が暗転するフェードアウト・フェードインの時間（ミリ秒）。デフォルトは<code>500</code>。</li>
    <li><strong>fade_color</strong> (任意): フェードの色を16進数で指定。デフォルトは<code>0x000000</code>（黒）。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>; 同じJumpSceneを使い、"stage_2"のデータで再起動する
[transition_scene scene=JumpScene data=stage_2]

; WorldMapSceneから、"ShopScene"に遷移する
[transition_scene scene=ShopScene data=shop_interior script=shop_keeper_talk]

; 赤い画面で、1秒かけてフェードしながらボス戦シーンに突入
[transition_scene scene=BossScene data=boss_room fade_color=0xff0000 fade_time=1000]
</code></pre>

<hr>

<h3>onOverlap_Start / onOverlap_End</h3>
<p>
    物理的に反発しない「センサー」ボディ同士が、重なり合った瞬間 (<code>onOverlap_Start</code>) と、重なりが解消された瞬間 (<code>onOverlap_End</code>) に発火します。
    当たり判定は欲しいが、通り抜けさせたいオブジェクト（アイテム、ワープゾーン、イベントエリアなど）に最適です。
</p>
<p>このトリガーを機能させるには、対象オブジェクトの物理プロパティで<strong>「センサー」</strong>チェックボックスを<code>true</code>に設定する必要があります。</p>

<h4>必須パラメータ:</h4>
<ul>
    <li>
        <strong><code>targetGroup</code></strong>: 反応する相手のグループ名。
        <br>例: <code>player</code>, <code>enemy_bullet</code>
    </li>
</ul>

<p><strong>使用例 (アイテム取得):</strong></p>
<pre><code>
--- イベント (コインオブジェクトに設定) ---
Trigger: onOverlap_Start
Target Group: player
Actions: [play_sound key=coin_get][destroy target=self]
</code></pre>

<hr>

<h3>onInteract</h3>
<p>
    プレイヤーが近くにいて、「調べる」キー（デフォルトは上矢印キー）を押した瞬間に発火します。扉を開ける、NPCに話しかける、宝箱を開けるといった「近接インタラクション」を実装するための専用トリガーです。
</p>
<p>このトリガーが機能するには、以下の3つの要素が正しく設定されている必要があります。</p>
<ol>
    <li>プレイヤーオブジェクトに<code>Interactor</code>コンポーネントがアタッチされていること。</li>
    <li>
        このオブジェクト（扉など）が、プレイヤーとの<code>onOverlap_Start</code>で<code>[interact_add]</code>タグを実行していること。
    </li>
    <li>
        このオブジェクトが、プレイヤーとの<code>onOverlap_End</code>で<code>[interact_remove]</code>タグを実行していること。
    </li>
</ol>
<p><strong>パラメータ:</strong> なし</p>

<!-- ====================================================== -->
<!-- 次に、アクションタグ・リファレンスのセクションに追加 -->
<!-- ====================================================== -->

<hr>

<h2>[interact_add]</h2>
<p>
    このタグを持つオブジェクト（扉、NPCなど）を、プレイヤーの「インタラクト可能リスト」に追加します。
    通常、プレイヤーとの<code>onOverlap_Start</code>イベントと組み合わせて使用します。これにより、プレイヤーがオブジェクトの近くにいる間だけ、「調べる」ことが可能になります。
</p>
<p><strong>パラメータ:</strong></p>
<ul>
    <li><strong>target</strong> (任意): <code>self</code>を指定するのが一般的です。これにより、このタグが設定されたオブジェクト自身がリストに追加されます。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>
--- イベント (扉オブジェクトに設定) ---
Trigger: onOverlap_Start
Target Group: player
Actions: [interact_add target=self][set_visible target=interact_mark value=true]
</code></pre>

<hr>

<h2>[interact_remove]</h2>
<p>
    このタグを持つオブジェクトを、プレイヤーの「インタラクト可能リスト」から削除します。
    通常、プレイヤーとの<code>onOverlap_End</code>イベントと組み合わせて使用します。これにより、プレイヤーがオブジェクトから離れると、「調べる」ことができなくなります。
</p>
<p><strong>パラメータ:</strong></p>
<ul>
    <li><strong>target</strong> (任意): <code>self</code>を指定するのが一般的です。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>
--- イベント (扉オブジェクトに設定) ---
Trigger: onOverlap_End
Target Group: player
Actions: [interact_remove target=self][set_visible target=interact_mark value=false]
</code></pre>

<hr>

<h2>[spawn_object]</h2>
<p>あらかじめ定義された「プレハブ（設計図）」に基づいて、新しいオブジェクトをシーンに出現させます。弾の発射、アイテムのドロップ、敵の出現など、動的なゲームプレイの核となるタグです。</p>
<p>プレハブは、<code>assets/data/prefabs/</code>フォルダ内に、単一のオブジェクト定義を持つJSONファイルとして作成します。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>prefab</strong> (必須): 出現させたいプレハブのキー（JSONファイル名から拡張子を除いたもの）。</li>
    <li><strong>name</strong> (任意): 出現するオブジェクトに固有の名前を付けたい場合に指定します。指定しない場合、<code>prefab名_タイムスタンプ</code>という名前が自動で付きます。</li>
    <li><strong>offsetX, offsetY</strong> (任意): タグを実行したオブジェクトの位置を基準とした、出現位置のオフセット（ずれ）を指定します。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>; 敵を倒した時に、その場に"coin"プレハブのオブジェクトを出現させる
[spawn_object prefab=coin]

; プレイヤーの右手側(X座標+50)から、"bullet"プレハブの弾を発射する
[spawn_object prefab=bullet offsetX=50]
</code></pre>

<hr>

<h2>[set_flip_x]</h2>
<p>対象オブジェクトを左右に反転させます。キャラクターが左右を向くアニメーションの代わりとして、あるいはそれと組み合わせて使用します。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>value</strong> (必須): <code>true</code>で左右反転（左向き）、<code>false</code>で通常表示（右向き）にします。</li>
</ul>
<p><strong>使用例 (onDirectionChangeと連携):</strong></p>
<pre><code>
--- イベント1: 左を向いた時 ---
Trigger: onDirectionChange
Condition: direction === 'left'
Actions: [set_flip_x value=true]

--- イベント2: 右を向いた時 ---
Trigger: onDirectionChange
Condition: direction === 'right'
Actions: [set_flip_x value=false]
</code></pre>

<hr>

<h2>[anim_stop]</h2>
<p>対象オブジェクトで現在再生中のスプライトアニメーションを停止し、その時点のフレームで静止させます。</p>
<p><strong>パラメータ:</strong> なし</p>
<p><strong>使用例:</strong></p>
<pre><code>
--- イベント: 歩行が中断された時 ---
Trigger: onStateChange
Condition: oldState === 'walk'
Actions: [anim_stop]
</code></pre>

<hr>

<h2>[anim_frame]</h2>
<p>対象オブジェクトを、特定のアニメーションの、特定のフレームで静止させます。アニメーションを再生することなく、キャラクターの「立ち絵」として特定のポーズを表示させたい場合に非常に便利です。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>name</strong> (必須): 参照したいアニメーションの名前（キー）を指定します。</li>
    <li><strong>frame</strong> (必須): 表示したいフレームの番号（0から始まる）。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>
; "walk"アニメーションの最初のフレーム(立ちポーズ)で静止させる
[anim_frame name=walk frame=0]

; "attack"アニメーションの3番目のフレーム(剣を振りかぶったポーズ)で静止させる
[anim_frame name=attack frame=2]
</code></pre>

<h2>[destroy]</h2>
<p>オブジェクトを破壊（シーンから削除）します。</p>
<ul>
    <li><strong>target</strong> (オプション): 破壊する対象を指定します。
        <ul>
            <li><code>self</code> (デフォルト): このイベントを持つオブジェクト自身。</li>
            <li><code>other</code>: このイベントを引き起こした衝突相手。</li>
            <li><code>オブジェクト名</code>: シーン上の特定の名前を持つオブジェクト。</li>
        </ul>
    </li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>[destroy]
[destroy target=self]
[destroy target=other]
[destroy target=secret_door]
</code></pre>

<hr>

<h2>[eval]</h2>
<p>ゲーム変数 (f.) やシステム変数 (sf.) を操作するJavaScript式を実行します。</p>
<ul>
    <li><strong>exp</strong> (必須): 実行する式を、必ずダブルクォーテーションで囲んで記述します。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>[eval exp="f.score = f.score + 10"]
[eval exp="f.has_key = true"]</code></pre>

<hr>

<h2>[tween]</h2>
<p>
    オブジェクトのプロパティを、滑らかに変化させるアニメーション（トゥイーン）を再生します。
    オブジェクトの移動、フェードイン/アウト、拡大縮小、回転など、あらゆる演出の基本となります。
    このタグは、無限ループでない限り、アニメーションが完了するまで次のアクションの実行を待ちます。
</p>

<h4>パラメータ:</h4>
<ul>
    <li>
        <strong>target</strong> (任意): アクションの対象を指定します。デフォルトは<code>self</code>。
    </li>
    <li>
        <strong>property</strong> (必須): 変化させたいプロパティ名。
        <br>例: <code>x</code>, <code>y</code>, <code>scale</code>, <code>scaleX</code>, <code>scaleY</code>, <code>angle</code>, <code>alpha</code>
    </li>
    <li>
        <strong>to</strong> (必須): 目標となる値。<code>"+=100"</code>や<code>"-=50"</code>といった、現在の値からの相対値も指定可能です。
    </li>
    <li>
        <strong>time</strong> (任意): アニメーション時間（ミリ秒）。デフォルトは<code>1000</code> (1秒)。
    </li>
    <li>
        <strong>ease</strong> (任意): 動きの緩急。デフォルトは<code>Linear</code> (等速)。
        <br>例: <code>Sine.easeInOut</code>, <code>Bounce.easeOut</code>, <code>Elastic.easeOut</code>
    </li>
    <li>
        <strong>loop</strong> (任意): アニメーションを繰り返す回数を指定します。<code>-1</code>を指定すると<strong>無限ループ</strong>になります。無限ループの場合、このタグは待機せずに即座に次のアクションへ進みます。
    </li>
    <li>
        <strong>yoyo</strong> (任意): <code>true</code>にすると、アニメーションが終点に達した後、始点まで逆再生します。<code>loop</code>と組み合わせることで、点滅や浮遊のような表現が可能になります。
    </li>
</ul>

<p><strong>基本的な使用例:</strong></p>
<pre><code>; 1秒かけて右に200ピクセル移動
[tween property=x to="+=200" time=1000]

; 0.5秒かけて、跳ねながらY座標500の位置に着地
[tween property=y to=500 time=500 ease=Bounce.easeOut]

; 0.3秒かけて1.5倍に拡大する
[tween property=scale to=1.5 time=300]
</code></pre>

<p><strong>無限ループの使用例 (テキストやUI向け):</strong></p>
<pre><code>
; 「Tap to Start」テキストをゆっくりと点滅させ続ける
[tween target=start_text property=alpha to=0.2 time=1500 ease=Sine.easeInOut yoyo=true loop=-1]

; 「！」マークを上下にフワフワと動かし続ける
[tween target=interact_mark property=y to="+=10" time=1000 ease=Sine.easeInOut yoyo=true loop=-1]
</code></pre>

<hr>

<h2>[apply_force]</h2>
<p>対象オブジェクトに物理的な「力」を加えます。オブジェクトは慣性や摩擦に従って加速します。ノックバックや、ジャンプの補助などに最適です。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>x</strong> (任意): X方向に加える力の大きさ。正の値で右、負の値で左。</li>
    <li><strong>y</strong> (任意): Y方向に加える力の大きさ。正の値で下、負の値で上。</li>
</ul>
<p><strong>注意:</strong> このタグは、<code>[body_velocity]</code>と異なり、現在の速度に力を「加算」します。値を大きくしすぎると、オブジェクトがすごい勢いで飛んでいく可能性があります。</p>
<p><strong>使用例:</strong></p>
<pre><code>; 敵に踏まれた時、上に少しだけ跳ね返る
[apply_force y=-0.05]

; 爆風で右に吹き飛ばされる
[apply_force x=0.2]
</code></pre>

<hr>

<h2>[body_velocity]</h2>
<p>対象オブジェクトの物理ボディの速度 (Velocity) を直接設定します。物理的な挙動を強制的に変更したい場合に使います。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>x</strong> (任意): X方向の速度を設定します。</li>
    <li><strong>y</strong> (任意): Y方向の速度を設定します。</li>
</ul>
<p><strong>注意:</strong> XとY、どちらか一方だけの指定も可能です。指定されなかった方向の速度は、現在の値を維持します。</p>
<p><strong>使用例:</strong></p>
<pre><code>; 右方向に速さ5で押し出す
[body_velocity x=5]

; 上方向に強く打ち上げる
[body_velocity y=-15]

; 右斜め上にジャンプさせる
[body_velocity x=7 y=-12]
</code></pre>

<hr>

<h2>[anim_play]</h2>
<p>対象オブジェクトのスプライトアニメーションを再生します。対象はスプライトである必要があります。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>name</strong> (必須): 再生したいアニメーションの名前（キー）を指定します。アニメーションは、あらかじめシーンのJSONで定義されている必要があります。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>; "walk" という名前のアニメーションを再生
[anim_play name=walk]

; "jump_attack" という名前のアニメーションを再生
[anim_play name=jump_attack]
</code></pre>

<hr>

<h2>[set_visible]</h2>
<p>対象オブジェクトの表示・非表示を切り替えます。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>value</strong> (必須): <code>true</code>で表示、<code>false</code>で非表示にします。</li>
</ul>
<p><strong>使用例:</strong></p>
<pre><code>; オブジェクトを非表示にする
[set_visible value=false]

; オブジェクトを再表示する
[set_visible value=true]
</code></pre>
<hr>

<h2>[play_sound]</h2>
<p>効果音（SFX）を再生します。あらかじめ<code>asset_define.json</code>でオーディオアセットとして読み込んでおく必要があります。</p>
<h4>パラメータ:</h4>
<ul>
    <li><strong>key</strong> (必須): 再生したい効果音のアセットキー。</li>
    <li><strong>volume</strong> (任意): 音量。<code>0.0</code>（無音）から<code>1.0</code>（最大音量）の範囲で指定します。デフォルトは<code>1.0</code>。</li>
    <li><strong>loop</strong> (任意): <code>true</code>にすると、効果音がループ再生されます。<code>[stop_sound]</code>タグ（未実装）で停止させるまで鳴り続けます。デフォルトは<code>false</code>。</li>
</ul>
<p><strong>注意:</strong> このタグは音の再生を「開始」するだけで、再生が完了するのを待ちません。すぐに次のアクションの処理に移ります。</p>
<p><strong>使用例:</strong></p>
<pre><code>; "jump_sfx" というキーの効果音を再生
[play_sound key=jump_sfx]

; 敵を倒した時の音を、少し小さめの音量で再生
[play_sound key=enemy_defeat_sfx volume=0.7]

; アイテム取得音がループ再生される (特殊な演出)
[play_sound key=item_get_loop loop=true]
</code></pre>
<!-- ====================================================== -->
<h2>カスタムイベントトリガー (エディタ)</h2>
<p>PlayerControllerのような特定のコンポーネントが、自身の状態変化を知らせるために発行する、独自のイベントです。これにより、オブジェクトの内部状態とアニメーションやサウンドを、エディタだけで簡単に関連付けることができます。</p>
<!-- ====================================================== -->

<h3>onStateChange</h3>
<p><code>PlayerController</code>コンポーネントが、自身の状態（<code>idle</code>, <code>walk</code>, <code>jump_up</code>, <code>fall_down</code>）を変更した瞬間に一度だけ発火します。</p>
<h4>利用可能な変数 (Condition欄):</h4>
<ul>
    <li>
        <strong><code>state</code></strong>: 遷移先の<strong>新しい</strong>状態名（文字列）。
        <br>例: <code>'idle'</code>, <code>'walk'</code>, <code>'jump_up'</code>, <code>'fall_down'</code>
    </li>
    <li>
        <strong><code>oldState</code></strong>: 遷移元の<strong>古い</strong>状態名（文字列）。
    </li>
</ul>

<p><strong>使用例 (アニメーション連携):</strong></p>
<pre><code>
--- イベント1: 歩き始め ---
Trigger: onStateChange
Condition: state === 'walk'
Actions: [anim_play name=walk_animation]

--- イベント2: 停止 ---
Trigger: onStateChange
Condition: state === 'idle'
Actions: [anim_frame name=walk_animation frame=0]

--- イベント3: 歩行終了時 ---
Trigger: onStateChange
Condition: oldState === 'walk'
Actions: [anim_stop]
</code></pre>

<hr>

<h3>onDirectionChange</h3>
<p><code>PlayerController</code>コンポーネントが、キャラクターの向き（<code>left</code>, <code>right</code>）を変更した瞬間に一度だけ発火します。</p>
<h4>利用可能な変数 (Condition欄):</h4>
<ul>
    <li>
        <strong><code>direction</code></strong>: 新しい向き（文字列）。
        <br>例: <code>'left'</code>, <code>'right'</code>
    </li>
</ul>

<p><strong>使用例 (左右反転):</strong></p>
<pre><code>
--- イベント1: 左を向いた時 ---
Trigger: onDirectionChange
Condition: direction === 'left'
Actions: [set_flip_x value=true]

--- イベント2: 右を向いた時 ---
Trigger: onDirectionChange
Condition: direction === 'right'
Actions: [set_flip_x value=false]
</code></pre>
